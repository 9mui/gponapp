{% extends "base.html" %}

{% block title %}–ù–æ–≤—ã–µ ONU{% endblock %}

{% block head %}
<style>
.recent-onus-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 20px 0;
}

.recent-onus-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.recent-onus-table th,
.recent-onus-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.recent-onus-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.recent-onus-table tr:hover {
    background-color: #f5f5f5;
}

.onu-serial {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #2c5282;
}

.datetime-cell {
    color: #666;
    font-size: 0.9em;
}

.refresh-info {
    color: #666;
    font-size: 0.9em;
    margin-top: 10px;
    text-align: center;
}

.no-data {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 40px;
}
</style>
{% endblock %}

{% block content %}
<div class="recent-onus-container">
    <h2>üÜï –ù–æ–≤—ã–µ ONU</h2>
    <p>–ù–µ–¥–∞–≤–Ω–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ ONU –≤–æ –≤—Å–µ—Ö OLT —Å–∏—Å—Ç–µ–º—ã</p>
    
    <table class="recent-onus-table" id="recentOnusTable">
        <thead>
            <tr>
                <th>OLT</th>
                <th>–ü–æ—Ä—Ç</th>
                <th>ONU ID</th>
                <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                <th>–ü–µ—Ä–≤–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ</th>
            </tr>
        </thead>
        <tbody id="recentOnusBody">
            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </tbody>
    </table>
    
    <div class="refresh-info" id="refreshInfo">
        –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã...
    </div>
</div>

<script>
let refreshTimer;

function loadRecentONUs() {
    fetch('/api/recent_onus')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('recentOnusBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">–ù–æ–≤—ã—Ö ONU –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(onu => `
                <tr>
                    <td><strong>${onu.olt_hostname}</strong><br><small>${onu.olt_ip}</small></td>
                    <td>${onu.port_name}</td>
                    <td>${onu.idonu}</td>
                    <td class="onu-serial">${onu.snonu}</td>
                    <td class="datetime-cell">${formatDateTime(onu.first_seen)}</td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            document.getElementById('recentOnusBody').innerHTML = 
                '<tr><td colspan="5" class="no-data">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        });
}

function formatDateTime(dateStr) {
    if (!dateStr) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    try {
        const date = new Date(dateStr);
        return date.toLocaleString('ru-RU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch (e) {
        return dateStr;
    }
}

function startAutoRefresh() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    loadRecentONUs();
    
    // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
    refreshTimer = setInterval(() => {
        loadRecentONUs();
        updateRefreshInfo();
    }, 120000); // 2 –º–∏–Ω—É—Ç—ã
}

function updateRefreshInfo() {
    const now = new Date();
    document.getElementById('refreshInfo').textContent = 
        `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${now.toLocaleTimeString('ru-RU')} (–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)`;
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', startAutoRefresh);

// –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
});
</script>
{% endblock %}