{% extends "base.html" %}
{% set title = "Недавно добавленные ONU" %}
{% set header = "Недавно добавленные ONU" %}

{% block content %}
<h2 style="margin:0 0 14px 0">Последние 20 добавленных</h2>

<div class="muted" style="margin:-6px 0 12px 0; font-size:13px">
  Список обновляется автоматически каждые 5 минут.
</div>

<div class="panel" style="border:none; background:transparent; box-shadow:none; padding:0">
  <table class="kv" id="recent-onu-table">
    <thead>
      <tr>
        <th>#</th>
        <th>SN</th>
        <th>OLT</th>
        <th>Первое обнаружение</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ loop.index }}</td>
        <td><a href="{{ url_for('onu_by_sn', sn=r[0]) }}">{{ r[0] }}</a></td>
        <td>{{ r[2] or "—" }}</td>
        <td>{{ r[1] or "—" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
(async function(){
  async function refresh() {
    try{
      const res = await fetch("{{ url_for('recent_onus_api') }}", {cache: 'no-store'});
      const data = await res.json();
      const tbody = document.querySelector('#recent-onu-table tbody');
      tbody.innerHTML = '';
      data.forEach((o, idx) => {
        const tr = document.createElement('tr');
        const snLink = `<a href="{{ url_for('onu_by_sn', sn='__SN__') }}">__SN__</a>`.replaceAll('__SN__', o.sn);
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${snLink}</td>
          <td>${o.olt_ip ?? '—'}</td>
          <td>${o.first_seen ?? '—'}</td>
        `;
        tbody.appendChild(tr);
      });
    }catch(e){ console.error('recent refresh failed', e); }
  }
  setTimeout(refresh, 2000);
  setInterval(refresh, 300000); // 5 minutes
})();
</script>
{% endblock %}
