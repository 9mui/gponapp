{% extends "base.html" %}
{% block content %}

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
<div class="onu-header">
  <h2 class="onu-title">ONU {{ sn }}</h2>
  <form method="post" action="{{ url_for('onu_reboot', sn=sn) }}"
        onsubmit="return confirm('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ONU {{ sn }}?')">
    <button class="btn warn">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ONU</button>
  </form>
</div>

<p class="onu-meta">
  OLT: {{ olt_ip }} |
  –ü–æ—Ä—Ç: {{ port_name_full }}
</p>

<!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤ -->
<div class="kv-wrap">
  <table class="kv">
    <tbody>
      <tr>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <td>
          {% if status == 3 %}
            <span class="status-dot ok" title="Online" aria-label="Online"></span>ONLINE
          {% elif status in [0,1,2] %}
            <span class="status-dot bad" title="Offline" aria-label="Offline"></span>OFFLINE
          {% else %}
            <span class="status-dot dim" title="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" aria-hidden="true"></span>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ({{ status }})
          {% endif %}
      </td>

      </tr>

      {# --- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å LAN: –æ–¥–∏–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å up/down (–∏–ª–∏ "–Ω/–¥") --- #}
      {% set sn_str = sn|string %}
      {% set lan_status_base = '-' %}
      {% if lan_list %}
        {% set ups = lan_list | selectattr('text','equalto','up') | list %}
        {% set downs = lan_list | selectattr('text','equalto','down') | list %}
        {% if ups|length > 0 %}
          {% set lan_status_base = 'up' %}
        {% elif downs|length > 0 %}
          {% set lan_status_base = 'down' %}
        {% else %}
          {% set lan_status_base = '-' %}
        {% endif %}
      {% else %}
        {% set lan_status_base = '-' %}
      {% endif %}

      {% set lan_status = lan_status_base %}
      {% if status == 3 and sn_str.startswith('5') %}
        {% set lan_status = 'up' %}
      {% endif %}

      <tr>
        <th>LAN-–ø–æ—Ä—Ç—ã ONU</th>
        <td>
          {% if lan_status == 'up' %}
            <span class="badge ok">up</span>
          {% elif lan_status == 'down' %}
            <span class="badge bad">down</span>
          {% else %}
            <span class="badge dim">–Ω/–¥</span>
          {% endif %}
          <!-- –û—Ç–ª–∞–¥–∫–∞: {{ lan_list|length if lan_list else 0 }} –ø–æ—Ä—Ç–æ–≤, glob_idx: {{ glob_idx or 'None' }} -->
        </td>
      </tr>



      <tr><th>RX (dBm)</th><td>{{ rx is not none and rx or "-" }}</td></tr>
      <tr><th>TX (dBm)</th><td>{{ tx is not none and tx or "-" }}</td></tr>
      <tr><th>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th><td>{{ vendor if vendor else "-" }}</td></tr>
      <tr><th>–î–∏—Å—Ç–∞–Ω—Ü–∏—è</th><td>{{ distance is not none and (distance|string + " –º") or "-" }}</td></tr>

      <tr>
        <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
        <td>
          <form method="post" action="{{ url_for('save_onu_note', sn=sn) }}" class="comment-row">
            <textarea name="note" rows="2" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏‚Ä¶" class="ta-note">{{ note or "" }}</textarea>
            <button class="btn soft icon-btn" type="submit" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
          </form>
        </td>
      </tr>

      {% if status in [0,1,2] %}
        <tr><th>–ü—Ä–∏—á–∏–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ</th><td>{{ last_down }}</td></tr>
      {% endif %}
      {% if status in [0,1,2] and last_online_snmp %}
      <tr>
        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ ONLINE</th>
        <td>{{ last_online_snmp }}</td>
      </tr>
      {% endif %}

    </tbody>
  </table>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<div class="onu-footer">
  <a class="btn soft" href="{{ url_for('onu_by_sn', sn=sn) }}">–û–±–Ω–æ–≤–∏—Ç—å</a>
</div>

<!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–Ω–∏–∑—É -->
<div class="onu-status-img">
  {% if status in [0,1,2] %}
    <img src="{{ url_for('static', filename='img/offline.png') }}" alt="ONU Offline">
  {% elif status == 3 %}
    {% if lan_status == 'up' %}
      <img src="{{ url_for('static', filename='img/online_up.png') }}" alt="ONU Online (LAN up)">
    {% else %}
      <img src="{{ url_for('static', filename='img/online_down.png') }}" alt="ONU Online (LAN down)">
    {% endif %}
  {% endif %}
</div>

<style>
  body {
    background-color: #0f141b; /* —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω */
    color: #e5e7eb;            /* —Å–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
  }

  .onu-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin: .25rem 0 .75rem;
  }
  .onu-title {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: #e5e7eb;
  }
  .onu-meta {
    margin: .25rem 0 1rem;
    color: #9aa2af;
    font-size: 1rem;
  }

  /* –ö–Ω–æ–ø–∫–∏ */
  .btn {
    display: inline-block;
    border: 1px solid transparent;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 15px;
    line-height: 1.2;
    cursor: pointer;
    text-decoration: none;
    text-align: center;
  }
  .btn.warn {
    background: #dc3545;
    color: #fff;
    border-color: #dc3545;
  }
  .btn.warn:hover {
    background: #b52a38;
    border-color: #b52a38;
  }
  .btn.soft {
    background: #1e2a36;
    color: #cfe4ff;
    border-color: #334b62;
  }
  .btn.soft:hover {
    background: #263545;
  }
  /* –º–∞–ª–µ–Ω—å–∫–∞—è –∏–∫–æ–Ω–∫–∞-–∫–Ω–æ–ø–∫–∞ */
  .btn.icon-btn{
    padding: 6px 8px;
    font-size: .95rem;
    line-height: 1;
    min-width: auto;
  }

  .onu-footer {
    margin-top: 14px;
    display: flex;
    justify-content: center;
  }

  /* –¢–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤: –¥–µ–ª–∞–µ–º —à–∏—Ä–µ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
  .kv-wrap { display: flex; justify-content: center; }
  .kv {
    border-collapse: collapse;
    font-size: 17px;
    /* —à–∏—Ä–∏–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ —Ç—è–Ω–µ—Ç—Å—è: –æ—Ç 520px –¥–æ 900px, –æ–±—ã—á–Ω–æ ~72% —ç–∫—Ä–∞–Ω–∞ */
    width: clamp(520px, 72vw, 900px);
  }
  .kv th, .kv td {
    border: 1px solid #2a2f3a;
    padding: 8px 12px;
    text-align: left;
    vertical-align: top;
  }
  .kv th {
    white-space: nowrap;
    font-weight: 600;
    color: #cbd5e1;
    width: 28%; /* —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–ª–æ–Ω–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
  }
  .kv td {
    color: #e5e7eb;
    width: 72%; /* –∫–æ–Ω—Ç–µ–Ω—Ç —à–∏—Ä–µ */
  }

  /* –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
  .comment-row{
    display:flex;
    align-items:flex-start;
    gap:8px;
    width:100%;
  }
  .ta-note{
    flex:1 1 auto;
    width:100%;
    min-height:44px;       /* —Å—Ç–∞—Ä—Ç: ~2 —Å—Ç—Ä–æ–∫–∏ */
    max-height:40vh;       /* –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
    resize:vertical;       /* –†–ï–°–ê–ô–ó –¢–û–õ–¨–ö–û –ü–û –í–ï–†–¢–ò–ö–ê–õ–ò */
    overflow:auto;
    padding:10px 12px;
    border-radius:10px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    color:#e5e7eb;
    box-sizing:border-box;
  }

  /* –ë–µ–π–¥–∂–∏ */
  .badge {
    display: inline-block;
    border-radius: 8px;
    padding: 2px 8px;
    font-size: 12px;
    border: 1px solid #2a2f3a;
    color: #e5e7eb;
  }
  .badge.ok  { background: #16361e; border-color: #225c33; color: #a6f0c2; }
  .badge.bad { background: #3b1619; border-color: #5c2227; color: #ffb3bb; }
  .badge.dim { background: #1a242f; border-color: #2b3b4e; color: #9aa2af; }

  /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ */
  .onu-status-img { text-align: center; margin-top: 20px; }
  .onu-status-img img { max-width: 380px; height: auto; }



  /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —Ä—è–¥–æ–º —Å —Ç–µ–∫—Å—Ç–æ–º */
  .status-dot{
    display:inline-block;
    width:10px; height:10px;
    border-radius:50%;
    margin-right:6px;
    vertical-align:middle;
    box-shadow:0 0 0 1px rgba(255,255,255,.15);
  }
  .status-dot.ok  { background:#20c997; } /* –∑–µ–ª—ë–Ω—ã–π */
   status-dot.bad { background:#dc3545; } /* –∫—Ä–∞—Å–Ω—ã–π  */
  .status-dot.dim { background:#6b7280; } /* —Å–µ—Ä—ã–π    */

</style>

{% endblock content %}
